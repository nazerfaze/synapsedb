# PostgreSQL Production Configuration for SynapseDB
# Optimized for distributed operations with pglogical and pgvector

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

listen_addresses = '*'
port = 5432
max_connections = 500
superuser_reserved_connections = 10

# SSL Configuration
ssl = on
ssl_cert_file = '/var/lib/postgresql/ssl/server.crt'
ssl_key_file = '/var/lib/postgresql/ssl/server.key'
ssl_ca_file = '/var/lib/postgresql/ssl/ca.crt'
ssl_crl_file = ''
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
ssl_prefer_server_ciphers = on

# Authentication
password_encryption = scram-sha-256

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------

# Memory
shared_buffers = 1GB                    # 25% of RAM
work_mem = 16MB                         # Increased for complex queries
maintenance_work_mem = 256MB            # For maintenance operations
effective_cache_size = 3GB              # Estimate of disk cache
max_worker_processes = 16               # Match CPU cores
max_parallel_workers = 8                # Parallel query workers
max_parallel_workers_per_gather = 4     # Per query parallel workers
max_parallel_maintenance_workers = 4    # Maintenance parallel workers

# Kernel Resource Usage
shared_memory_type = mmap

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG (Critical for Replication)
#------------------------------------------------------------------------------

# WAL Configuration for Logical Replication
wal_level = logical                     # Required for pglogical
wal_log_hints = on                      # Required for replication
max_wal_senders = 20                    # Allow many replication connections
max_replication_slots = 20              # Logical replication slots
max_worker_processes = 16               # Include logical workers
max_logical_replication_workers = 8     # Logical replication workers
max_sync_workers_per_subscription = 4   # Sync workers per subscription

# WAL Archiving and Streaming
archive_mode = on
archive_command = 'test ! -f /var/lib/postgresql/data/archive/%f && cp %p /var/lib/postgresql/data/archive/%f'
wal_keep_size = 2GB                     # Keep WAL for replication
max_wal_size = 4GB                      # Maximum WAL size before checkpoint
min_wal_size = 256MB                    # Minimum WAL size
wal_compression = on                    # Compress WAL
wal_init_zero = off                     # Performance optimization
wal_recycle = off                       # Performance optimization

# Checkpoints
checkpoint_timeout = 5min               # Checkpoint frequency
checkpoint_completion_target = 0.9      # Spread checkpoint I/O
checkpoint_warning = 30s                # Warn on long checkpoints

# Background Writer
bgwriter_delay = 200ms                  # Background writer delay
bgwriter_lru_maxpages = 100            # Pages written per round
bgwriter_lru_multiplier = 2.0          # Multiplier for dirty pages
bgwriter_flush_after = 512kB           # Flush after this much dirty data

#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------

# Standby Servers
hot_standby = on                        # Allow queries on standby
max_standby_archive_delay = 30s         # Max delay for archive recovery
max_standby_streaming_delay = 30s       # Max delay for streaming replication
wal_receiver_status_interval = 10s      # Status update interval
hot_standby_feedback = on               # Send feedback to primary
wal_receiver_timeout = 60s              # Receiver timeout
wal_sender_timeout = 60s                # Sender timeout

# Synchronous Replication (for critical data)
synchronous_commit = on                 # Synchronous commit by default
synchronous_standby_names = ''          # Will be configured per environment

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Planner Method Configuration
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on
enable_seqscan = on
enable_indexscan = on
enable_indexonlyscan = on
enable_bitmapscan = on

# Planner Cost Constants
random_page_cost = 1.5                  # SSD optimized
seq_page_cost = 1.0                    # Sequential read cost
cpu_tuple_cost = 0.01                  # CPU cost per tuple
cpu_index_tuple_cost = 0.005           # CPU cost per index tuple
cpu_operator_cost = 0.0025             # CPU cost per operator
effective_io_concurrency = 200          # Concurrent I/O for bitmap scans
maintenance_io_concurrency = 10         # Concurrent I/O for maintenance

# Genetic Query Optimizer
geqo = on
geqo_threshold = 12
geqo_effort = 5
geqo_pool_size = 0
geqo_generations = 0

# Other Planner Options
default_statistics_target = 100         # Statistics sampling target
constraint_exclusion = partition        # Enable constraint exclusion
cursor_tuple_fraction = 0.1            # Cursor optimization
from_collapse_limit = 8                # FROM list collapse limit
join_collapse_limit = 8                # JOIN collapse limit

#------------------------------------------------------------------------------
# REPORTING AND LOGGING
#------------------------------------------------------------------------------

# Where to Log
logging_collector = on                  # Enable logging collector
log_destination = 'stderr,csvlog'      # Log destinations
log_directory = '/var/lib/postgresql/data/log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_truncate_on_rotation = off
log_rotation_age = 1d
log_rotation_size = 100MB

# When to Log
log_min_messages = info                 # Minimum message level
log_min_error_statement = error         # Log statements causing errors
log_min_duration_statement = 1000       # Log slow queries (1 second)

# What to Log
debug_print_parse = off
debug_print_rewritten = off
debug_print_plan = off
debug_pretty_print = on
log_checkpoints = on                    # Log checkpoints
log_connections = on                    # Log connections
log_disconnections = on                 # Log disconnections
log_duration = off                      # Don't log all durations
log_error_verbosity = default           # Error verbosity
log_hostname = on                       # Include hostname in logs
log_line_prefix = '%t [%p]: [%l-1] db=%d,user=%u,app=%a,client=%h '
log_lock_waits = on                     # Log lock waits
log_statement = 'ddl'                   # Log DDL statements
log_temp_files = 10MB                   # Log temp files above size
log_timezone = 'UTC'

#------------------------------------------------------------------------------
# PROCESS TITLE
#------------------------------------------------------------------------------

cluster_name = 'synapsedb'             # Cluster name in process titles
update_process_title = on

#------------------------------------------------------------------------------
# STATISTICS
#------------------------------------------------------------------------------

# Statistics Collector
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl                    # Track PL/pgSQL functions
stats_temp_directory = 'pg_stat_tmp'

# Statistics Monitoring
compute_query_id = on
log_statement_stats = off
log_parser_stats = off
log_planner_stats = off
log_executor_stats = off

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Statement Behavior
search_path = '"$user", public'        # Schema search path
default_tablespace = ''                # Default tablespace
temp_tablespaces = ''                  # Temp tablespaces
default_table_access_method = heap     # Default table access method

# Locale and Formatting
datestyle = 'iso, mdy'
intervalstyle = 'postgres'
timezone = 'UTC'
timezone_abbreviations = 'Default'
extra_float_digits = 1
client_encoding = utf8
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# Shared Library Preloading
shared_preload_libraries = 'pglogical,pg_cron,pg_stat_statements'
session_preload_libraries = ''
local_preload_libraries = ''

# Other Defaults
dynamic_library_path = '$libdir'
gin_pending_list_limit = 4MB

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------

deadlock_timeout = 1s
max_locks_per_transaction = 256         # Increased for complex operations
max_pred_locks_per_transaction = 64     # Predicate locks
max_pred_locks_per_relation = -2        # Per relation predicate locks
max_pred_locks_per_page = 2            # Per page predicate locks

#------------------------------------------------------------------------------
# VERSION AND PLATFORM COMPATIBILITY
#------------------------------------------------------------------------------

array_nulls = on
backslash_quote = safe_encoding
escape_string_warning = on
lo_compat_privileges = off
operator_precedence_warning = off
quote_all_identifiers = off
standard_conforming_strings = on
synchronize_seqscans = on

#------------------------------------------------------------------------------
# ERROR HANDLING
#------------------------------------------------------------------------------

exit_on_error = off                     # Don't exit on errors
restart_after_crash = on                # Restart after crashes

#------------------------------------------------------------------------------
# CONFIG FILE INCLUDES
#------------------------------------------------------------------------------

# Include files from conf.d directory
include_dir = 'conf.d'

#------------------------------------------------------------------------------
# PGLOGICAL SPECIFIC SETTINGS
#------------------------------------------------------------------------------

# Logical Replication Settings
pglogical.conflict_resolution = 'last_update_wins'
pglogical.conflict_log_level = 'LOG'
pglogical.batch_size = 1000
pglogical.use_spi = on
pglogical.temp_directory = '/tmp'

#------------------------------------------------------------------------------
# PGVECTOR SPECIFIC SETTINGS
#------------------------------------------------------------------------------

# Vector extension settings will be added when pgvector supports them
# Currently most configuration is done at index creation time

#------------------------------------------------------------------------------
# CUSTOM SYNAPSEDB SETTINGS
#------------------------------------------------------------------------------

# Custom settings for SynapseDB cluster coordination
# These will be set by the cluster management system
synapsedb.node_id = ''
synapsedb.node_name = ''
synapsedb.cluster_name = 'synapsedb'
synapsedb.shard_count = '256'
synapsedb.replication_factor = '3'