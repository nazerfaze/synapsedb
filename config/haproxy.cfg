global
    daemon
    maxconn 2000
    log stdout local0 info

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    retries 3

# Statistics interface
stats enable
stats uri /stats
stats refresh 10s
stats show-node
stats show-legends

# Writer endpoint (port 5000) - routes to active writer only
frontend writer_frontend
    bind *:5000
    default_backend writer_nodes

backend writer_nodes
    balance first
    option tcp-check
    tcp-check connect
    tcp-check send "SELECT 1;\n"
    tcp-check expect string "1"
    
    # Node 1 (default writer)
    server node1 172.20.0.10:5432 check inter 5s fall 2 rise 2 weight 100
    server node2 172.20.0.11:5432 check inter 5s fall 2 rise 2 weight 50 backup
    server node3 172.20.0.12:5432 check inter 5s fall 2 rise 2 weight 50 backup

# Reader endpoint (port 5001) - load balances across all healthy nodes  
frontend reader_frontend
    bind *:5001
    default_backend reader_nodes

backend reader_nodes
    balance roundrobin
    option tcp-check
    tcp-check connect
    tcp-check send "SELECT 1;\n"
    tcp-check expect string "1"
    
    server node1 172.20.0.10:5432 check inter 5s fall 2 rise 2 weight 100
    server node2 172.20.0.11:5432 check inter 5s fall 2 rise 2 weight 100
    server node3 172.20.0.12:5432 check inter 5s fall 2 rise 2 weight 100

# HTTP stats interface
frontend stats_frontend
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE